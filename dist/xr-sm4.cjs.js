"use strict";var textDecoding=require("text-decoding");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var textDecoding__default=_interopDefaultLegacy(textDecoding);function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_toPropertyKey(n.key),n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}for(var byteLength_1=byteLength,toByteArray_1=toByteArray,fromByteArray_1=fromByteArray,lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");e=e.indexOf("="),t=(e=-1===e?t:e)===t?0:4-e%4;return[e,t]}function byteLength(e){var e=getLens(e),t=e[0],e=e[1];return 3*(t+e)/4-e}function _byteLength(e,t,r){return 3*(t+r)/4-r}function toByteArray(e){for(var t,r=getLens(e),n=r[0],r=r[1],o=new Arr(_byteLength(e,n,r)),i=0,a=0<r?n-4:n,u=0;u<a;u+=4)t=revLookup[e.charCodeAt(u)]<<18|revLookup[e.charCodeAt(u+1)]<<12|revLookup[e.charCodeAt(u+2)]<<6|revLookup[e.charCodeAt(u+3)],o[i++]=t>>16&255,o[i++]=t>>8&255,o[i++]=255&t;return 2===r&&(t=revLookup[e.charCodeAt(u)]<<2|revLookup[e.charCodeAt(u+1)]>>4,o[i++]=255&t),1===r&&(t=revLookup[e.charCodeAt(u)]<<10|revLookup[e.charCodeAt(u+1)]<<4|revLookup[e.charCodeAt(u+2)]>>2,o[i++]=t>>8&255,o[i++]=255&t),o}function tripletToBase64(e){return lookup[e>>18&63]+lookup[e>>12&63]+lookup[e>>6&63]+lookup[63&e]}function encodeChunk(e,t,r){for(var n,o=[],i=t;i<r;i+=3)n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),o.push(tripletToBase64(n));return o.join("")}function fromByteArray(e){for(var t,r=e.length,n=r%3,o=[],i=16383,a=0,u=r-n;a<u;a+=i)o.push(encodeChunk(e,a,u<a+i?u:a+i));return 1==n?(t=e[r-1],o.push(lookup[t>>2]+lookup[t<<4&63]+"==")):2==n&&(t=(e[r-2]<<8)+e[r-1],o.push(lookup[t>>10]+lookup[t>>4&63]+lookup[t<<2&63]+"=")),o.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63;var base64Js={byteLength:byteLength_1,toByteArray:toByteArray_1,fromByteArray:fromByteArray_1},Crypt=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"stringToArrayBufferInUtf8",value:function(e){return(new("undefined"==typeof window?textDecoding__default.default:window.TextEncoder)).encode(e)}},{key:"utf8ArrayBufferToString",value:function(e){return new("undefined"==typeof window?textDecoding__default.default:window.TextDecoder)("utf-8").decode(e)}},{key:"arrayBufferToBase64",value:function(e){return base64Js.fromByteArray(e)}},{key:"base64ToArrayBuffer",value:function(e){return base64Js.toByteArray(e)}}]),e}(),crypt=Crypt,UINT8_BLOCK=16,Sbox=Uint8Array.from([214,144,233,254,204,225,61,183,22,182,20,194,40,251,44,5,43,103,154,118,42,190,4,195,170,68,19,38,73,134,6,153,156,66,80,244,145,239,152,122,51,84,11,67,237,207,172,98,228,179,28,169,201,8,232,149,128,223,148,250,117,143,63,166,71,7,167,252,243,115,23,186,131,89,60,25,230,133,79,168,104,107,129,178,113,100,218,139,248,235,15,75,112,86,157,53,30,36,14,94,99,88,209,162,37,34,124,59,1,33,120,135,212,0,70,87,159,211,39,82,76,54,2,231,160,196,200,158,234,191,138,210,64,199,56,181,163,247,242,206,249,97,21,161,224,174,93,164,155,52,26,85,173,147,50,48,245,140,177,227,29,246,226,46,130,102,202,96,192,41,35,171,13,83,78,111,213,219,55,69,222,253,142,47,3,255,106,114,109,108,91,81,141,27,175,146,187,221,188,127,17,217,92,65,31,16,90,216,10,193,49,136,165,205,123,189,45,116,208,18,184,229,180,176,137,105,151,74,12,150,119,126,101,185,241,9,197,110,198,132,24,240,125,236,58,220,77,32,121,238,95,62,215,203,57,72]),CK=Uint32Array.from([462357,472066609,943670861,1415275113,1886879365,2358483617,2830087869,3301692121,3773296373,4228057617,404694573,876298825,1347903077,1819507329,2291111581,2762715833,3234320085,3705924337,4177462797,337322537,808926789,1280531041,1752135293,2223739545,2695343797,3166948049,3638552301,4110090761,269950501,741554753,1213159005,1684763257]),FK=Uint32Array.from([2746333894,1453994832,1736282519,2993693404]),SM4=function(){function r(e){_classCallCheck(this,r);var t=crypt.stringToArrayBufferInUtf8(e.key);if(16!==t.length)throw new Error("key should be a 16 bytes string");this.key=t;t=new Uint8Array(0);if(void 0!==e.iv&&null!==e.iv&&16!==(t=crypt.stringToArrayBufferInUtf8(e.iv)).length)throw new Error("iv should be a 16 bytes string");this.iv=t,0<=[this.mode="cbc","ecb"].indexOf(e.mode)&&(this.mode=e.mode),0<=[this.cipherType="base64","text"].indexOf(e.outType)&&(this.cipherType=e.outType),this.encryptRoundKeys=new Uint32Array(32),this.spawnEncryptRoundKeys(),this.decryptRoundKeys=Uint32Array.from(this.encryptRoundKeys),this.decryptRoundKeys.reverse()}return _createClass(r,[{key:"doBlockCrypt",value:function(e,t){var r=new Uint32Array(36);r.set(e,0);for(var n=0;n<32;n++)r[n+4]=r[n]^this.tTransform1(r[n+1]^r[n+2]^r[n+3]^t[n]);e=new Uint32Array(4);return e[0]=r[35],e[1]=r[34],e[2]=r[33],e[3]=r[32],e}},{key:"spawnEncryptRoundKeys",value:function(){var e=new Uint32Array(4),t=(e[0]=this.key[0]<<24|this.key[1]<<16|this.key[2]<<8|this.key[3],e[1]=this.key[4]<<24|this.key[5]<<16|this.key[6]<<8|this.key[7],e[2]=this.key[8]<<24|this.key[9]<<16|this.key[10]<<8|this.key[11],e[3]=this.key[12]<<24|this.key[13]<<16|this.key[14]<<8|this.key[15],new Uint32Array(36));t[0]=e[0]^FK[0],t[1]=e[1]^FK[1],t[2]=e[2]^FK[2],t[3]=e[3]^FK[3];for(var r=0;r<32;r++)t[r+4]=t[r]^this.tTransform2(t[r+1]^t[r+2]^t[r+3]^CK[r]),this.encryptRoundKeys[r]=t[r+4]}},{key:"rotateLeft",value:function(e,t){return e<<t|e>>>32-t}},{key:"linearTransform1",value:function(e){return e^this.rotateLeft(e,2)^this.rotateLeft(e,10)^this.rotateLeft(e,18)^this.rotateLeft(e,24)}},{key:"linearTransform2",value:function(e){return e^this.rotateLeft(e,13)^this.rotateLeft(e,23)}},{key:"tauTransform",value:function(e){return Sbox[e>>>24&255]<<24|Sbox[e>>>16&255]<<16|Sbox[e>>>8&255]<<8|Sbox[255&e]}},{key:"tTransform1",value:function(e){e=this.tauTransform(e);return this.linearTransform1(e)}},{key:"tTransform2",value:function(e){e=this.tauTransform(e);return this.linearTransform2(e)}},{key:"padding",value:function(e){var t,r;return null===e?null:(t=UINT8_BLOCK-e.length%UINT8_BLOCK,(r=new Uint8Array(e.length+t)).set(e,0),r.fill(t,e.length),r)}},{key:"dePadding",value:function(e){var t;return null===e?null:(t=e[e.length-1],e.slice(0,e.length-t))}},{key:"uint8ToUint32Block",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,r=new Uint32Array(4);return r[0]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],r[1]=e[t+4]<<24|e[t+5]<<16|e[t+6]<<8|e[t+7],r[2]=e[t+8]<<24|e[t+9]<<16|e[t+10]<<8|e[t+11],r[3]=e[t+12]<<24|e[t+13]<<16|e[t+14]<<8|e[t+15],r}},{key:"encrypt",value:function(e){var e=crypt.stringToArrayBufferInUtf8(e),t=this.padding(e),r=t.length/UINT8_BLOCK,n=new Uint8Array(t.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var o=this.uint8ToUint32Block(this.iv),i=0;i<r;i++)for(var a=i*UINT8_BLOCK,u=this.uint8ToUint32Block(t,a),y=(o[0]=o[0]^u[0],o[1]=o[1]^u[1],o[2]=o[2]^u[2],o[3]=o[3]^u[3],this.doBlockCrypt(o,this.encryptRoundKeys)),o=y,s=0;s<UINT8_BLOCK;s++)n[a+s]=y[parseInt(s/4)]>>(3-s)%4*8&255}else for(var f=0;f<r;f++)for(var l=f*UINT8_BLOCK,c=this.uint8ToUint32Block(t,l),h=this.doBlockCrypt(c,this.encryptRoundKeys),p=0;p<UINT8_BLOCK;p++)n[l+p]=h[parseInt(p/4)]>>(3-p)%4*8&255;return"base64"===this.cipherType?crypt.arrayBufferToBase64(n):crypt.utf8ArrayBufferToString(n)}},{key:"decrypt",value:function(e){var t=new Uint8Array,r=(t="base64"===this.cipherType?crypt.base64ToArrayBuffer(e):crypt.stringToArrayBufferInUtf8(e)).length/UINT8_BLOCK,n=new Uint8Array(t.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var o=this.uint8ToUint32Block(this.iv),i=0;i<r;i++){var a=i*UINT8_BLOCK,u=this.uint8ToUint32Block(t,a),y=this.doBlockCrypt(u,this.decryptRoundKeys),s=new Uint32Array(4);s[0]=o[0]^y[0],s[1]=o[1]^y[1],s[2]=o[2]^y[2],s[3]=o[3]^y[3];for(var o=u,f=0;f<UINT8_BLOCK;f++)n[a+f]=s[parseInt(f/4)]>>(3-f)%4*8&255}}else for(var l=0;l<r;l++)for(var c=l*UINT8_BLOCK,h=this.uint8ToUint32Block(t,c),p=this.doBlockCrypt(h,this.decryptRoundKeys),d=0;d<UINT8_BLOCK;d++)n[c+d]=p[parseInt(d/4)]>>(3-d)%4*8&255;e=this.dePadding(n);return crypt.utf8ArrayBufferToString(e)}}]),r}(),XrSM4=SM4,lib=SM4;module.exports=lib;
