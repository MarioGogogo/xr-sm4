"use strict";var util=require("util");function _interopDefaultLegacy(r){return r&&"object"==typeof r&&"default"in r?r:{default:r}}var util__default=_interopDefaultLegacy(util);function _classCallCheck(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(r,e){for(var t=0;t<e.length;t++){var n=e[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(r,_toPropertyKey(n.key),n)}}function _createClass(r,e,t){return e&&_defineProperties(r.prototype,e),t&&_defineProperties(r,t),Object.defineProperty(r,"prototype",{writable:!1}),r}function _toPrimitive(r,e){if("object"!=typeof r||null===r)return r;var t=r[Symbol.toPrimitive];if(void 0===t)return("string"===e?String:Number)(r);t=t.call(r,e||"default");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}function _toPropertyKey(r){r=_toPrimitive(r,"string");return"symbol"==typeof r?r:String(r)}for(var byteLength_1=byteLength,toByteArray_1=toByteArray,fromByteArray_1=fromByteArray,lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(r){var e=r.length;if(0<e%4)throw new Error("Invalid string. Length must be a multiple of 4");r=r.indexOf("="),e=(r=-1===r?e:r)===e?0:4-r%4;return[r,e]}function byteLength(r){var r=getLens(r),e=r[0],r=r[1];return 3*(e+r)/4-r}function _byteLength(r,e,t){return 3*(e+t)/4-t}function toByteArray(r){for(var e,t=getLens(r),n=t[0],t=t[1],o=new Arr(_byteLength(r,n,t)),i=0,a=0<t?n-4:n,u=0;u<a;u+=4)e=revLookup[r.charCodeAt(u)]<<18|revLookup[r.charCodeAt(u+1)]<<12|revLookup[r.charCodeAt(u+2)]<<6|revLookup[r.charCodeAt(u+3)],o[i++]=e>>16&255,o[i++]=e>>8&255,o[i++]=255&e;return 2===t&&(e=revLookup[r.charCodeAt(u)]<<2|revLookup[r.charCodeAt(u+1)]>>4,o[i++]=255&e),1===t&&(e=revLookup[r.charCodeAt(u)]<<10|revLookup[r.charCodeAt(u+1)]<<4|revLookup[r.charCodeAt(u+2)]>>2,o[i++]=e>>8&255,o[i++]=255&e),o}function tripletToBase64(r){return lookup[r>>18&63]+lookup[r>>12&63]+lookup[r>>6&63]+lookup[63&r]}function encodeChunk(r,e,t){for(var n,o=[],i=e;i<t;i+=3)n=(r[i]<<16&16711680)+(r[i+1]<<8&65280)+(255&r[i+2]),o.push(tripletToBase64(n));return o.join("")}function fromByteArray(r){for(var e,t=r.length,n=t%3,o=[],i=16383,a=0,u=t-n;a<u;a+=i)o.push(encodeChunk(r,a,u<a+i?u:a+i));return 1==n?(e=r[t-1],o.push(lookup[e>>2]+lookup[e<<4&63]+"==")):2==n&&(e=(r[t-2]<<8)+r[t-1],o.push(lookup[e>>10]+lookup[e>>4&63]+lookup[e<<2&63]+"=")),o.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63;var base64Js={byteLength:byteLength_1,toByteArray:toByteArray_1,fromByteArray:fromByteArray_1},Crypt=function(){function r(){_classCallCheck(this,r)}return _createClass(r,null,[{key:"stringToArrayBufferInUtf8",value:function(r){return(new("undefined"==typeof window?util__default.default:window).TextEncoder).encode(r)}},{key:"utf8ArrayBufferToString",value:function(r){return new("undefined"==typeof window?util__default.default:window).TextDecoder("utf-8").decode(r)}},{key:"arrayBufferToBase64",value:function(r){return base64Js.fromByteArray(r)}},{key:"base64ToArrayBuffer",value:function(r){return base64Js.toByteArray(r)}}]),r}(),crypt=Crypt,UINT8_BLOCK=16,Sbox=Uint8Array.from([214,144,233,254,204,225,61,183,22,182,20,194,40,251,44,5,43,103,154,118,42,190,4,195,170,68,19,38,73,134,6,153,156,66,80,244,145,239,152,122,51,84,11,67,237,207,172,98,228,179,28,169,201,8,232,149,128,223,148,250,117,143,63,166,71,7,167,252,243,115,23,186,131,89,60,25,230,133,79,168,104,107,129,178,113,100,218,139,248,235,15,75,112,86,157,53,30,36,14,94,99,88,209,162,37,34,124,59,1,33,120,135,212,0,70,87,159,211,39,82,76,54,2,231,160,196,200,158,234,191,138,210,64,199,56,181,163,247,242,206,249,97,21,161,224,174,93,164,155,52,26,85,173,147,50,48,245,140,177,227,29,246,226,46,130,102,202,96,192,41,35,171,13,83,78,111,213,219,55,69,222,253,142,47,3,255,106,114,109,108,91,81,141,27,175,146,187,221,188,127,17,217,92,65,31,16,90,216,10,193,49,136,165,205,123,189,45,116,208,18,184,229,180,176,137,105,151,74,12,150,119,126,101,185,241,9,197,110,198,132,24,240,125,236,58,220,77,32,121,238,95,62,215,203,57,72]),CK=Uint32Array.from([462357,472066609,943670861,1415275113,1886879365,2358483617,2830087869,3301692121,3773296373,4228057617,404694573,876298825,1347903077,1819507329,2291111581,2762715833,3234320085,3705924337,4177462797,337322537,808926789,1280531041,1752135293,2223739545,2695343797,3166948049,3638552301,4110090761,269950501,741554753,1213159005,1684763257]),FK=Uint32Array.from([2746333894,1453994832,1736282519,2993693404]),SM4=function(){function t(r){_classCallCheck(this,t);var e=crypt.stringToArrayBufferInUtf8(r.key);if(16!==e.length)throw new Error("key should be a 16 bytes string");this.key=e;e=new Uint8Array(0);if(void 0!==r.iv&&null!==r.iv&&16!==(e=crypt.stringToArrayBufferInUtf8(r.iv)).length)throw new Error("iv should be a 16 bytes string");this.iv=e,0<=[this.mode="cbc","ecb"].indexOf(r.mode)&&(this.mode=r.mode),0<=[this.cipherType="base64","text"].indexOf(r.outType)&&(this.cipherType=r.outType),this.encryptRoundKeys=new Uint32Array(32),this.spawnEncryptRoundKeys(),this.decryptRoundKeys=Uint32Array.from(this.encryptRoundKeys),this.decryptRoundKeys.reverse()}return _createClass(t,[{key:"doBlockCrypt",value:function(r,e){var t=new Uint32Array(36);t.set(r,0);for(var n=0;n<32;n++)t[n+4]=t[n]^this.tTransform1(t[n+1]^t[n+2]^t[n+3]^e[n]);r=new Uint32Array(4);return r[0]=t[35],r[1]=t[34],r[2]=t[33],r[3]=t[32],r}},{key:"spawnEncryptRoundKeys",value:function(){var r=new Uint32Array(4),e=(r[0]=this.key[0]<<24|this.key[1]<<16|this.key[2]<<8|this.key[3],r[1]=this.key[4]<<24|this.key[5]<<16|this.key[6]<<8|this.key[7],r[2]=this.key[8]<<24|this.key[9]<<16|this.key[10]<<8|this.key[11],r[3]=this.key[12]<<24|this.key[13]<<16|this.key[14]<<8|this.key[15],new Uint32Array(36));e[0]=r[0]^FK[0],e[1]=r[1]^FK[1],e[2]=r[2]^FK[2],e[3]=r[3]^FK[3];for(var t=0;t<32;t++)e[t+4]=e[t]^this.tTransform2(e[t+1]^e[t+2]^e[t+3]^CK[t]),this.encryptRoundKeys[t]=e[t+4]}},{key:"rotateLeft",value:function(r,e){return r<<e|r>>>32-e}},{key:"linearTransform1",value:function(r){return r^this.rotateLeft(r,2)^this.rotateLeft(r,10)^this.rotateLeft(r,18)^this.rotateLeft(r,24)}},{key:"linearTransform2",value:function(r){return r^this.rotateLeft(r,13)^this.rotateLeft(r,23)}},{key:"tauTransform",value:function(r){return Sbox[r>>>24&255]<<24|Sbox[r>>>16&255]<<16|Sbox[r>>>8&255]<<8|Sbox[255&r]}},{key:"tTransform1",value:function(r){r=this.tauTransform(r);return this.linearTransform1(r)}},{key:"tTransform2",value:function(r){r=this.tauTransform(r);return this.linearTransform2(r)}},{key:"padding",value:function(r){var e,t;return null===r?null:(e=UINT8_BLOCK-r.length%UINT8_BLOCK,(t=new Uint8Array(r.length+e)).set(r,0),t.fill(e,r.length),t)}},{key:"dePadding",value:function(r){var e;return null===r?null:(e=r[r.length-1],r.slice(0,r.length-e))}},{key:"uint8ToUint32Block",value:function(r){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,t=new Uint32Array(4);return t[0]=r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3],t[1]=r[e+4]<<24|r[e+5]<<16|r[e+6]<<8|r[e+7],t[2]=r[e+8]<<24|r[e+9]<<16|r[e+10]<<8|r[e+11],t[3]=r[e+12]<<24|r[e+13]<<16|r[e+14]<<8|r[e+15],t}},{key:"encrypt",value:function(r){var r=crypt.stringToArrayBufferInUtf8(r),e=this.padding(r),t=e.length/UINT8_BLOCK,n=new Uint8Array(e.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var o=this.uint8ToUint32Block(this.iv),i=0;i<t;i++)for(var a=i*UINT8_BLOCK,u=this.uint8ToUint32Block(e,a),y=(o[0]=o[0]^u[0],o[1]=o[1]^u[1],o[2]=o[2]^u[2],o[3]=o[3]^u[3],this.doBlockCrypt(o,this.encryptRoundKeys)),o=y,s=0;s<UINT8_BLOCK;s++)n[a+s]=y[parseInt(s/4)]>>(3-s)%4*8&255}else for(var f=0;f<t;f++)for(var l=f*UINT8_BLOCK,h=this.uint8ToUint32Block(e,l),c=this.doBlockCrypt(h,this.encryptRoundKeys),p=0;p<UINT8_BLOCK;p++)n[l+p]=c[parseInt(p/4)]>>(3-p)%4*8&255;return"base64"===this.cipherType?crypt.arrayBufferToBase64(n):crypt.utf8ArrayBufferToString(n)}},{key:"decrypt",value:function(r){var e=new Uint8Array,t=(e="base64"===this.cipherType?crypt.base64ToArrayBuffer(r):crypt.stringToArrayBufferInUtf8(r)).length/UINT8_BLOCK,n=new Uint8Array(e.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var o=this.uint8ToUint32Block(this.iv),i=0;i<t;i++){var a=i*UINT8_BLOCK,u=this.uint8ToUint32Block(e,a),y=this.doBlockCrypt(u,this.decryptRoundKeys),s=new Uint32Array(4);s[0]=o[0]^y[0],s[1]=o[1]^y[1],s[2]=o[2]^y[2],s[3]=o[3]^y[3];for(var o=u,f=0;f<UINT8_BLOCK;f++)n[a+f]=s[parseInt(f/4)]>>(3-f)%4*8&255}}else for(var l=0;l<t;l++)for(var h=l*UINT8_BLOCK,c=this.uint8ToUint32Block(e,h),p=this.doBlockCrypt(c,this.decryptRoundKeys),d=0;d<UINT8_BLOCK;d++)n[h+d]=p[parseInt(d/4)]>>(3-d)%4*8&255;r=this.dePadding(n);return crypt.utf8ArrayBufferToString(r)}}]),t}(),XrSM4=SM4,lib=SM4;module.exports=lib;
