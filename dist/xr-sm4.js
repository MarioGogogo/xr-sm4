!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("util")):"function"==typeof define&&define.amd?define(["util"],r):(t="undefined"!=typeof globalThis?globalThis:t||self).XrSM4=r(t.util)}(this,function(t){"use strict";function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var e=r(t);function n(t,r){if(!(t instanceof r))throw new TypeError("Cannot call a class as a function")}function i(t,r){for(var e=0;e<r.length;e++){var n=r[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,function(t){t=function(t,r){if("object"!=typeof t||null===t)return t;var e=t[Symbol.toPrimitive];if(void 0===e)return("string"===r?String:Number)(t);e=e.call(t,r||"default");if("object"!=typeof e)return e;throw new TypeError("@@toPrimitive must return a primitive value.")}(t,"string");return"symbol"==typeof t?t:String(t)}(n.key),n)}}function o(t,r,e){r&&i(t.prototype,r),e&&i(t,e),Object.defineProperty(t,"prototype",{writable:!1})}for(var t=function(t){var t=d(t),r=t[0],t=t[1];return 3*(r+t)/4-t},u=function(t){var r,e,n=d(t),i=n[0],n=n[1],o=new y(function(t,r){return 3*(t+r)/4-r}(i,n)),u=0,a=0<n?i-4:i;for(e=0;e<a;e+=4)r=s[t.charCodeAt(e)]<<18|s[t.charCodeAt(e+1)]<<12|s[t.charCodeAt(e+2)]<<6|s[t.charCodeAt(e+3)],o[u++]=r>>16&255,o[u++]=r>>8&255,o[u++]=255&r;2===n&&(r=s[t.charCodeAt(e)]<<2|s[t.charCodeAt(e+1)]>>4,o[u++]=255&r);1===n&&(r=s[t.charCodeAt(e)]<<10|s[t.charCodeAt(e+1)]<<4|s[t.charCodeAt(e+2)]>>2,o[u++]=r>>8&255,o[u++]=255&r);return o},a=function(t){for(var r,e=t.length,n=e%3,i=[],o=0,u=e-n;o<u;o+=16383)i.push(function(t,r,e){for(var n,i=[],o=r;o<e;o+=3)n=(t[o]<<16&16711680)+(t[o+1]<<8&65280)+(255&t[o+2]),i.push(function(t){return f[t>>18&63]+f[t>>12&63]+f[t>>6&63]+f[63&t]}(n));return i.join("")}(t,o,u<o+16383?u:o+16383));1==n?(r=t[e-1],i.push(f[r>>2]+f[r<<4&63]+"==")):2==n&&(r=(t[e-2]<<8)+t[e-1],i.push(f[r>>10]+f[r>>4&63]+f[r<<2&63]+"="));return i.join("")},f=[],s=[],y="undefined"!=typeof Uint8Array?Uint8Array:Array,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,c=h.length;l<c;++l)f[l]=h[l],s[h.charCodeAt(l)]=l;function d(t){var r=t.length;if(0<r%4)throw new Error("Invalid string. Length must be a multiple of 4");t=t.indexOf("="),r=(t=-1===t?r:t)===r?0:4-t%4;return[t,r]}s["-".charCodeAt(0)]=62,s["_".charCodeAt(0)]=63;var v={byteLength:t,toByteArray:u,fromByteArray:a},p=function(){function t(){n(this,t)}return o(t,null,[{key:"stringToArrayBufferInUtf8",value:function(t){return(new("undefined"==typeof window?e.default:window).TextEncoder).encode(t)}},{key:"utf8ArrayBufferToString",value:function(t){return new("undefined"==typeof window?e.default:window).TextDecoder("utf-8").decode(t)}},{key:"arrayBufferToBase64",value:function(t){return v.fromByteArray(t)}},{key:"base64ToArrayBuffer",value:function(t){return v.toByteArray(t)}}]),t}(),k=16,A=Uint8Array.from([214,144,233,254,204,225,61,183,22,182,20,194,40,251,44,5,43,103,154,118,42,190,4,195,170,68,19,38,73,134,6,153,156,66,80,244,145,239,152,122,51,84,11,67,237,207,172,98,228,179,28,169,201,8,232,149,128,223,148,250,117,143,63,166,71,7,167,252,243,115,23,186,131,89,60,25,230,133,79,168,104,107,129,178,113,100,218,139,248,235,15,75,112,86,157,53,30,36,14,94,99,88,209,162,37,34,124,59,1,33,120,135,212,0,70,87,159,211,39,82,76,54,2,231,160,196,200,158,234,191,138,210,64,199,56,181,163,247,242,206,249,97,21,161,224,174,93,164,155,52,26,85,173,147,50,48,245,140,177,227,29,246,226,46,130,102,202,96,192,41,35,171,13,83,78,111,213,219,55,69,222,253,142,47,3,255,106,114,109,108,91,81,141,27,175,146,187,221,188,127,17,217,92,65,31,16,90,216,10,193,49,136,165,205,123,189,45,116,208,18,184,229,180,176,137,105,151,74,12,150,119,126,101,185,241,9,197,110,198,132,24,240,125,236,58,220,77,32,121,238,95,62,215,203,57,72]),g=Uint32Array.from([462357,472066609,943670861,1415275113,1886879365,2358483617,2830087869,3301692121,3773296373,4228057617,404694573,876298825,1347903077,1819507329,2291111581,2762715833,3234320085,3705924337,4177462797,337322537,808926789,1280531041,1752135293,2223739545,2695343797,3166948049,3638552301,4110090761,269950501,741554753,1213159005,1684763257]),T=Uint32Array.from([2746333894,1453994832,1736282519,2993693404]);return function(){function e(t){n(this,e);var r=p.stringToArrayBufferInUtf8(t.key);if(16!==r.length)throw new Error("key should be a 16 bytes string");this.key=r;r=new Uint8Array(0);if(void 0!==t.iv&&null!==t.iv&&16!==(r=p.stringToArrayBufferInUtf8(t.iv)).length)throw new Error("iv should be a 16 bytes string");this.iv=r,0<=[this.mode="cbc","ecb"].indexOf(t.mode)&&(this.mode=t.mode),0<=[this.cipherType="base64","text"].indexOf(t.outType)&&(this.cipherType=t.outType),this.encryptRoundKeys=new Uint32Array(32),this.spawnEncryptRoundKeys(),this.decryptRoundKeys=Uint32Array.from(this.encryptRoundKeys),this.decryptRoundKeys.reverse()}return o(e,[{key:"doBlockCrypt",value:function(t,r){var e=new Uint32Array(36);e.set(t,0);for(var n=0;n<32;n++)e[n+4]=e[n]^this.tTransform1(e[n+1]^e[n+2]^e[n+3]^r[n]);t=new Uint32Array(4);return t[0]=e[35],t[1]=e[34],t[2]=e[33],t[3]=e[32],t}},{key:"spawnEncryptRoundKeys",value:function(){var t=new Uint32Array(4),r=(t[0]=this.key[0]<<24|this.key[1]<<16|this.key[2]<<8|this.key[3],t[1]=this.key[4]<<24|this.key[5]<<16|this.key[6]<<8|this.key[7],t[2]=this.key[8]<<24|this.key[9]<<16|this.key[10]<<8|this.key[11],t[3]=this.key[12]<<24|this.key[13]<<16|this.key[14]<<8|this.key[15],new Uint32Array(36));r[0]=t[0]^T[0],r[1]=t[1]^T[1],r[2]=t[2]^T[2],r[3]=t[3]^T[3];for(var e=0;e<32;e++)r[e+4]=r[e]^this.tTransform2(r[e+1]^r[e+2]^r[e+3]^g[e]),this.encryptRoundKeys[e]=r[e+4]}},{key:"rotateLeft",value:function(t,r){return t<<r|t>>>32-r}},{key:"linearTransform1",value:function(t){return t^this.rotateLeft(t,2)^this.rotateLeft(t,10)^this.rotateLeft(t,18)^this.rotateLeft(t,24)}},{key:"linearTransform2",value:function(t){return t^this.rotateLeft(t,13)^this.rotateLeft(t,23)}},{key:"tauTransform",value:function(t){return A[t>>>24&255]<<24|A[t>>>16&255]<<16|A[t>>>8&255]<<8|A[255&t]}},{key:"tTransform1",value:function(t){t=this.tauTransform(t);return this.linearTransform1(t)}},{key:"tTransform2",value:function(t){t=this.tauTransform(t);return this.linearTransform2(t)}},{key:"padding",value:function(t){var r,e;return null===t?null:(r=k-t.length%k,(e=new Uint8Array(t.length+r)).set(t,0),e.fill(r,t.length),e)}},{key:"dePadding",value:function(t){var r;return null===t?null:(r=t[t.length-1],t.slice(0,t.length-r))}},{key:"uint8ToUint32Block",value:function(t){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,e=new Uint32Array(4);return e[0]=t[r]<<24|t[r+1]<<16|t[r+2]<<8|t[r+3],e[1]=t[r+4]<<24|t[r+5]<<16|t[r+6]<<8|t[r+7],e[2]=t[r+8]<<24|t[r+9]<<16|t[r+10]<<8|t[r+11],e[3]=t[r+12]<<24|t[r+13]<<16|t[r+14]<<8|t[r+15],e}},{key:"encrypt",value:function(t){var t=p.stringToArrayBufferInUtf8(t),r=this.padding(t),e=r.length/k,n=new Uint8Array(r.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var i=this.uint8ToUint32Block(this.iv),o=0;o<e;o++)for(var u=o*k,a=this.uint8ToUint32Block(r,u),f=(i[0]=i[0]^a[0],i[1]=i[1]^a[1],i[2]=i[2]^a[2],i[3]=i[3]^a[3],this.doBlockCrypt(i,this.encryptRoundKeys)),i=f,s=0;s<k;s++)n[u+s]=f[parseInt(s/4)]>>(3-s)%4*8&255}else for(var y=0;y<e;y++)for(var h=y*k,l=this.uint8ToUint32Block(r,h),c=this.doBlockCrypt(l,this.encryptRoundKeys),d=0;d<k;d++)n[h+d]=c[parseInt(d/4)]>>(3-d)%4*8&255;return"base64"===this.cipherType?p.arrayBufferToBase64(n):p.utf8ArrayBufferToString(n)}},{key:"decrypt",value:function(t){var r=new Uint8Array,e=(r="base64"===this.cipherType?p.base64ToArrayBuffer(t):p.stringToArrayBufferInUtf8(t)).length/k,n=new Uint8Array(r.length);if("cbc"===this.mode){if(null===this.iv||16!==this.iv.length)throw new Error("iv error");for(var i=this.uint8ToUint32Block(this.iv),o=0;o<e;o++){var u=o*k,a=this.uint8ToUint32Block(r,u),f=this.doBlockCrypt(a,this.decryptRoundKeys),s=new Uint32Array(4);s[0]=i[0]^f[0],s[1]=i[1]^f[1],s[2]=i[2]^f[2],s[3]=i[3]^f[3];for(var i=a,y=0;y<k;y++)n[u+y]=s[parseInt(y/4)]>>(3-y)%4*8&255}}else for(var h=0;h<e;h++)for(var l=h*k,c=this.uint8ToUint32Block(r,l),d=this.doBlockCrypt(c,this.decryptRoundKeys),v=0;v<k;v++)n[l+v]=d[parseInt(v/4)]>>(3-v)%4*8&255;t=this.dePadding(n);return p.utf8ArrayBufferToString(t)}}]),e}()});
